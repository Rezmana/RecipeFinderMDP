package com.example.recipefinder

import android.os.Bundle
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.view.WindowManager
import android.widget.*
import androidx.appcompat.widget.AppCompatImageButton
import androidx.fragment.app.DialogFragment
import androidx.lifecycle.lifecycleScope
import androidx.navigation.fragment.findNavController
import androidx.navigation.fragment.navArgs
import com.example.recipefinder.database.RoomDB
import com.example.recipefinder.entities.Recipe
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.squareup.picasso.Picasso
import kotlinx.coroutines.launch
import java.util.UUID

class FoodDialogDetailsFragmentOld : DialogFragment() {

    private val args: FoodDialogDetailsFragmentArgs by navArgs()

    private lateinit var foodPicture: ImageView
    private lateinit var userName : TextView
    private lateinit var foodName: TextView
    private lateinit var recipeDescription : TextView
    private lateinit var typeCuisine: TextView
    private lateinit var ingredientsList: LinearLayout
    private lateinit var btnSaveRecipe : AppCompatImageButton
    private lateinit var seeMoreButton : Button

    private val commentsList = mutableListOf<Comments>()


    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        return inflater.inflate(R.layout.fragment_dialog_food_details, container, false)
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        // Initialize views

        foodPicture = view.findViewById(R.id.foodPicture)
        recipeDescription = view.findViewById(R.id.etDialogFoodDescription)
        foodName = view.findViewById(R.id.foodName)
        typeCuisine = view.findViewById(R.id.cookingTypes)
        userName = view.findViewById(R.id.author)
        ingredientsList = view.findViewById(R.id.ingredientsList)
        btnSaveRecipe = view.findViewById(R.id.btnSaveRecipe)
        seeMoreButton = view.findViewById(R.id.seeMoreButton)

        // Load recipe details from arguments
        val recipe: Recipe = args.recipe
        displayFoodDetails(recipe)

        btnSaveRecipe.setOnClickListener {
            saveRecipeForUser(recipe)
//            saveRecipesLocally()
        }

        seeMoreButton.setOnClickListener {

            detailedRecipeView(recipe)
//            val navController = findNavController()
//
//            requireActivity().findNavController(R.id.nav_host_fragment_activity_dashboardapp).navigate(
//                FoodDialogDetailsFragmentDirections.actionFoodDialogDetailsFragmentToFoodDetailsFragment(recipe)
//            )
//            val navController = requireActivity().supportFragmentManager
//                .findFragmentById(R.id.fragmentContainerView)
//                ?.findNavController()
//
//            navController?.navigate(
//                FoodDialogDetailsFragmentDirections.actionFoodDialogDetailsFragmentToFoodDetailsFragment(recipe)
//            )
//            dismiss()
//            detailedRecipeView(args.recipe)
//            val action = FoodDialogDetailsFragmentDirections.actionFoodDialogDetailsFragmentToFoodDetailsFragment(recipe)
//            findNavController().navigate(action)
//            Log.d("FoodDialogDetailsFragment", "See More button clicked for recipe: ${recipe.recipeName}")
//            detailedRecipeView(recipe) // Pass the current recipe to the function
//            val navController = findNavController()
//            if (navController.currentDestination?.id == R.id.foodDialogDetailsFragment) {
//                navController.navigate(R.id.action_foodDialogDetailsFragment_to_foodDetailsFragment)
//            } else if (navController.currentDestination?.id == R.id.navigation_home) {
//                // Navigate using a different action or method suitable for HomeFragment
//                navController.navigate(R.id.action_navigation_home_to_foodDetailsFragment) // Replace with your actual action ID
//            }
        }

        // Add Comment Button functionality
    }

    companion object {
        fun newInstance(recipe: Recipe): FoodDialogDetailsFragmentOld {
            val fragment = FoodDialogDetailsFragmentOld()
            val args = Bundle().apply {
                putParcelable("recipe", recipe)
            }
            fragment.arguments = args
            return fragment
        }
    }

    private fun displayFoodDetails(recipe: Recipe) {
        foodName.text = recipe.recipeName
        userName.text = recipe.userName
        recipeDescription.text = recipe.recipeDescription
        typeCuisine.text = "${recipe.typeCuisine ?: "N/A"}"
//

        // Load image using Picasso
        recipe.imageUri?.let {
            Picasso.get()
                .load(it)
                .placeholder(R.drawable.background_placeholder)
//                .error(R.drawable.error_image)
                .into(foodPicture)
        } ?: run {
            foodPicture.setImageResource(R.drawable.background_placeholder)
        }

        populateIngredients(recipe.ingredients)
    }

    private fun populateIngredients(ingredients: List<String>) {
        // Clear existing views
        ingredientsList.removeAllViews()

        // Add each ingredient as a TextView
        for (ingredient in ingredients) {
            val ingredientView = TextView(requireContext()).apply {
                text = "- $ingredient"
                textSize = 14f
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.WRAP_CONTENT,
                    LinearLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    bottomMargin = 8 // Add spacing between items
                }
            }
            ingredientsList.addView(ingredientView)
        }
    }
    override fun onStart() {
        super.onStart()
        dialog?.window?.setLayout(
            (resources.displayMetrics.widthPixels * 0.85).toInt(),
            WindowManager.LayoutParams.WRAP_CONTENT
        )
        dialog?.window?.setBackgroundDrawableResource(android.R.color.white)
    }
    private fun saveRecipeForUser(recipe: Recipe) {
        // Get current user's ID
        val user = FirebaseAuth.getInstance().currentUser
        if (user == null) {
            Toast.makeText(context, "You need to log in to save recipes", Toast.LENGTH_SHORT).show()
            return
        }

        val userId = user.uid
        val recipeId = recipe.id.ifEmpty { UUID.randomUUID().toString() }
        Log.d("FirestoreDebug", "Saving recipe with path: users/$userId/savedRecipes/$recipeId")
        // Reference to Firestore
        val firestore = FirebaseFirestore.getInstance()

        // Save recipe under user's savedRecipes subcollection
//        val userRef = firestore.collection("users").document(userId)
//        val savedRecipeRef = userRef.collection("savedRecipes").document(recipe.id)
        val savedRecipeRef = firestore
            .collection("users")
            .document(userId)
            .collection("savedRecipes")
            .document(recipeId)

        savedRecipeRef.set(recipe)
            .addOnSuccessListener {
                saveRecipeLocally(recipe)
                Toast.makeText(context, "Recipe saved successfully!", Toast.LENGTH_SHORT).show()
            }
            .addOnFailureListener { e ->
                Toast.makeText(context, "Failed to save recipe: ${e.message}", Toast.LENGTH_SHORT).show()
            }
    }

    private fun saveRecipeLocally(recipe: Recipe) {
        val database = RoomDB.getDatabase(requireContext())
        val recipeDao = database.recipeDao()

        // Save the recipe locally in a coroutine
        lifecycleScope.launch {
            recipeDao.saveRecipe(recipe)
            Toast.makeText(requireContext(), "Recipe saved locally!", Toast.LENGTH_SHORT).show()
        }
    }

    private fun detailedRecipeView(recipe: Recipe) {
////        val action = FoodDialogDetailsFragmentDirections.actionFoodDialogDetailsFragmentToFoodDetailsFragment(recipe)
////        findNavController().navigate(action)
//        val action = FoodDialogDetailsFragmentDirections.actionFoodDialogDetailsFragmentToFoodDetailsFragment(recipe)
//        findNavController().navigate(action)
//
//        val action = HomeFragmentDirections.actionNavigationHomeToFoodDetailsFragment(recipe)
//        findNavController().navigate(action)
        val navController = requireActivity().supportFragmentManager
            .findFragmentById(R.id.fragmentContainerView)
            ?.findNavController()

        navController?.navigate(
            FoodDialogDetailsFragmentDirections.actionFoodDialogDetailsFragmentToFoodDetailsFragment(recipe)
        )
    }
}

